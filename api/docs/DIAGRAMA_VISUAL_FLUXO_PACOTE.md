# ğŸ“Š Diagrama Visual: Fluxo Completo de Pagamento de Pacote

## 1ï¸âƒ£ **VISÃƒO GERAL DO FLUXO**

```
FASE 1: REQUISIÃ‡ÃƒO DO PAGAMENTO
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                          â”‚
â”‚  Cliente no APP                                         â”‚
â”‚  (aluno_id=72, usuario_id=3)                           â”‚
â”‚                                                          â”‚
â”‚  Clica: "Pagar Pacote 4"                               â”‚
â”‚         â†“                                               â”‚
â”‚       POST /mobile/pacotes/contratos/4/pagar           â”‚
â”‚       Authorization: Bearer {token}                     â”‚
â”‚                                                          â”‚
â”‚  Resposta:                                             â”‚
â”‚  {                                                     â”‚
â”‚    "payment_url": "https://checkout.mp.../...",      â”‚
â”‚    "preference_id": "123abc456"                        â”‚
â”‚  }                                                     â”‚
â”‚         â†“                                               â”‚
â”‚  window.location.href = payment_url                    â”‚
â”‚  (Redireciona para Mercado Pago)                       â”‚
â”‚                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

FASE 2: CÃ”ORDENAÃ‡ÃƒO MERCADO PAGO
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                          â”‚
â”‚  Mercado Pago                                           â”‚
â”‚                                                          â”‚
â”‚  Cliente clica: "Pagar R$ 2.00"                        â”‚
â”‚        (Autoriza assinatura recorrente)                â”‚
â”‚         â†“                                               â”‚
â”‚  âœ… Payment Approved                                    â”‚
â”‚  âœ… Preapproval Authorized                             â”‚
â”‚         â†“                                               â”‚
â”‚  Envia Webhook #1 (subscription_preapproval)           â”‚
â”‚  Envia Webhook #2 (payment - primeira cobranÃ§a)        â”‚
â”‚                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

FASE 3: PROCESSAMENTO BACKEND
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                          â”‚
â”‚  API AppCheckin                                         â”‚
â”‚                                                          â”‚
â”‚  [Webhook #1 Chega]                                    â”‚
â”‚  type: 'subscription_preapproval'                      â”‚
â”‚  id: '123abc456'                                       â”‚
â”‚         â†“                                               â”‚
â”‚  criarMatriculaPagantePacote(4)                        â”‚
â”‚         â†“                                               â”‚
â”‚  âœ… MatrÃ­cula 500 (pagante/aluno 72)                   â”‚
â”‚  âœ… Assinatura 300 (com pacote_contrato_id=4)          â”‚
â”‚         â†“                                               â”‚
â”‚  â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€
â”‚         â†“                                               â”‚
â”‚  [Webhook #2 Chega]                                    â”‚
â”‚  type: 'payment'                                       â”‚
â”‚  id: 146079536501                                      â”‚
â”‚  external_reference: 'PAC-4-1771434041'                â”‚
â”‚         â†“                                               â”‚
â”‚  processarPagamentoPacote(4)                           â”‚
â”‚         â†“                                               â”‚
â”‚  âœ… MatrÃ­cula 501 (beneficiÃ¡rio/aluno 94)             â”‚
â”‚  âœ… MatrÃ­cula 502 (beneficiÃ¡rio/aluno 95)             â”‚
â”‚  âœ… MatrÃ­cula 503 (beneficiÃ¡rio/aluno 96)             â”‚
â”‚  âœ… 4 Pagamentos marcados como "pago"                  â”‚
â”‚  âœ… Contrato 4 marcado como "ativo"                    â”‚
â”‚                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

FASE 4: RESULTADO FINAL
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                          â”‚
â”‚  Banco de Dados                                         â”‚
â”‚                                                          â”‚
â”‚  pacote_contratos:                                     â”‚
â”‚    id=4, status="ativo", pagamento_id=146079536501     â”‚
â”‚                                                          â”‚
â”‚  matriculas:                                           â”‚
â”‚    500 (aluno 72 - pagante) status=ativa              â”‚
â”‚    501 (aluno 94 - benef.) status=ativa               â”‚
â”‚    502 (aluno 95 - benef.) status=ativa               â”‚
â”‚    503 (aluno 96 - benef.) status=ativa               â”‚
â”‚                                                          â”‚
â”‚  assinaturas:                                          â”‚
â”‚    300 (matricula 500) gateway_id=123abc456            â”‚
â”‚        pacote_contrato_id=4 status=ativa              â”‚
â”‚        PRÃ“XIMAS COBRANÃ‡AS: automÃ¡ticas todo mÃªs       â”‚
â”‚                                                          â”‚
â”‚  pagamentos_plano:                                     â”‚
â”‚    (4 registros de pagamentos "pago")                 â”‚
â”‚    Total: R$ 2.00 rateado em 4 pessoas                â”‚
â”‚                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2ï¸âƒ£ **DECISÃƒO CRÃTICA: RECORRENTE vs AVULSO**

```
if (permite_recorrencia = true) {
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘          PACOTE RECORRENTE (Assinatura)          â•‘
    â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
    â•‘                                                   â•‘
    â•‘  API MP: criarPreferenciaAssinatura()            â•‘
    â•‘          â””â”€â†’ POST /preapproval_plan              â•‘
    â•‘                                                   â•‘
    â•‘  Webhook 1: subscription_preapproval             â•‘
    â•‘             â””â”€â†’ Cria matrÃ­cula pagante           â•‘
    â•‘                                                   â•‘
    â•‘  Webhook 2: payment                              â•‘
    â•‘             â””â”€â†’ Cria matrÃ­culas beneficiÃ¡rios    â•‘
    â•‘                                                   â•‘
    â•‘  PrÃ³ximas CobranÃ§as:                             â•‘
    â•‘     MÃªs 2: AutomÃ¡tico (MP cobra cartÃ£o)          â•‘
    â•‘     MÃªs 3: AutomÃ¡tico (MP cobra cartÃ£o)          â•‘
    â•‘     ...                                           â•‘
    â•‘  (atÃ© cancelar)                                   â•‘
    â•‘                                                   â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
} else {
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘          PACOTE AVULSO (Pagamento Ãºnico)         â•‘
    â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
    â•‘                                                   â•‘
    â•‘  API MP: criarPreferenciaPagamento()             â•‘
    â•‘          â””â”€â†’ POST /checkout/preferences          â•‘
    â•‘                                                   â•‘
    â•‘  Webhook: payment                                â•‘
    â•‘           â””â”€â†’ Cria 4 matrÃ­culas + 4 pagamentos   â•‘
    â•‘                                                   â•‘
    â•‘  PrÃ³ximas CobranÃ§as:                             â•‘
    â•‘     NENHUMA (paga uma Ãºnica vez)                 â•‘
    â•‘                                                   â•‘
    â•‘  Nota: Sem assinatura, sem renovaÃ§Ã£o automÃ¡tica  â•‘
    â•‘                                                   â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
}
```

---

## 3ï¸âƒ£ **DADOS NO BANCO DURANTE PROCESSAMENTO**

### **ApÃ³s Webhook #1 (subscription_preapproval)**

```
ANTES:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ pacote_contratos                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚ id   â”‚ status â”‚ pagante â”‚ pla... â”‚                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¤                  â”‚
â”‚  4   â”‚ 'pendente'  â”‚  3   â”‚  1  â”‚                â”‚
â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜                  â”‚

matriculas: VAZIA
assinaturas: VAZIA


DEPOIS DO WEBHOOK #1:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ matriculas                                       â”‚
â”œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚ id  â”‚ aluno_id â”‚ pacote_contrato_id â”‚ status â”‚  â”‚
â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤        â”‚
â”‚ 500 â”‚    72    â”‚      4      â”‚ ativa   â”‚        â”‚
â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ assinaturas                                      â”‚
â”œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ id  â”‚ mat_id   â”‚ gateway_id   â”‚ pacote_id     â”‚â”‚
â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚
â”‚ 300 â”‚   500    â”‚ 123abc456    â”‚      4        â”‚â”‚
â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚

Neste ponto:
  âœ… Pagante jÃ¡ tem matrÃ­cula ativa
  âœ… Assinatura criada (aguarda cobranÃ§a)
  â³ BeneficiÃ¡rios: ainda nÃ£o existem
  â³ Pagamentos: ainda nÃ£o existem
```

### **ApÃ³s Webhook #2 (payment)**

```
DEPOIS DO WEBHOOK #2:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ matriculas (COMPLETO!)                          â”‚
â”œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚ id  â”‚ aluno_id â”‚ pacote_contrato_id â”‚ status  â”‚ â”‚
â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤        â”‚
â”‚ 500 â”‚    72    â”‚      4       â”‚ ativa  â”‚        â”‚
â”‚ 501 â”‚    94    â”‚      4       â”‚ ativa  â”‚        â”‚
â”‚ 502 â”‚    95    â”‚      4       â”‚ ativa  â”‚        â”‚
â”‚ 503 â”‚    96    â”‚      4       â”‚ ativa  â”‚        â”‚
â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ pagamentos_plano                                â”‚
â”œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚ id  â”‚ mat_id   â”‚ valor  â”‚ status   â”‚            â”‚
â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤            â”‚
â”‚  X  â”‚   500    â”‚  2.00  â”‚   pago   â”‚            â”‚
â”‚  Y  â”‚   501    â”‚  0.50  â”‚   pago   â”‚            â”‚
â”‚  Z  â”‚   502    â”‚  0.50  â”‚   pago   â”‚            â”‚
â”‚  W  â”‚   503    â”‚  0.50  â”‚   pago   â”‚            â”‚
â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ pacote_contratos                                 â”‚
â”œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚ id  â”‚ status   â”‚ pagamento_id    â”‚              â”‚
â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚
â”‚  4  â”‚ 'ativo'  â”‚  146079536501   â”‚              â”‚
â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚

Resultado Final:
  âœ… 4 matrÃ­culas ativas
  âœ… 4 pagamentos registrados
  âœ… Contrato ativo
  âœ… Assinatura aguardando prÃ³ximo ciclo
```

---

## 4ï¸âƒ£ **RECUPERAÃ‡ÃƒO DO PACOTE: Com vs Sem Metadata**

```
CENÃRIO 1: Com Metadata (Ideal)
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘ Webhook chega                                      â•‘
â•‘ {                                                  â•‘
â•‘   "metadata": {                                    â•‘
â•‘     "tipo": "pacote",                             â•‘
â•‘     "pacote_contrato_id": 4   â† âœ… PRESENTE       â•‘
â•‘   }                                                â•‘
â•‘ }                                                  â•‘
â•‘         â†“                                           â•‘
â•‘ Extrair: contratoId = metadata['pacote_contrato_id']
â•‘         â†“                                           â•‘
â•‘ âœ… Process rÃ¡pido                                 â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•


CENÃRIO 2: Sem Metadata (NOVO - Problema 146079536501)
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘ Webhook chega                                      â•‘
â•‘ {                                                  â•‘
â•‘   "metadata": {}  â† âŒ VAZIO!                     â•‘
â•‘   "external_reference": "PAC-4-1771434041"       â•‘
â•‘ }                                                  â•‘
â•‘         â†“                                           â•‘
â•‘ FALLBACK #1: Check metadata['tipo']               â•‘
â•‘             â†’ nulo âŒ                              â•‘
â•‘         â†“                                           â•‘
â•‘ FALLBACK #2: Regex external_reference             â•‘
â•‘             â†’ PAC-(\d+)- â†’ contratoId = 4 âœ…      â•‘
â•‘         â†“                                           â•‘
â•‘ (Se ainda nÃ£o tivesse matrÃ­cula do pagante:)      â•‘
â•‘ FALLBACK #3: Buscar assinatura                    â•‘
â•‘             WHERE pacote_contrato_id = 4          â•‘
â•‘             â†’ Recupera pacote âœ…âœ…                â”‚
â•‘         â†“                                           â•‘
â•‘ âœ… Process mesmo sem metadata!                    â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

## 5ï¸âƒ£ **CICLO MENSAL AUTOMÃTICO (Se Recorrente)**

```
MÃŠS 1: Pagamento Inicial
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Cliente autoriza assinatura    â”‚
â”‚        â†“                        â”‚
â”‚ Webhook #1: preapproval        â”‚
â”‚ criarMatriculaPagantePacote()  â”‚
â”‚        â†“                        â”‚
â”‚ Webhook #2: payment #1         â”‚
â”‚ processarPagamentoPacote()     â”‚
â”‚        â†“                        â”‚
â”‚ âœ… 4 matrÃ­culas ativas        â”‚
â”‚ âœ… Assinatura ativa            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
    (30 dias depois)
         â†“
MÃŠS 2: CobranÃ§a AutomÃ¡tica
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MP cobra cartÃ£o automaticamente â”‚
â”‚        â†“                        â”‚
â”‚ payment_id = 999999            â”‚
â”‚ externa_reference = "PAC-4-..." â”‚
â”‚        â†“                        â”‚
â”‚ Webhook: payment #2            â”‚
â”‚ processarPagamentoPacote()     â”‚
â”‚        â†“                        â”‚
â”‚ âœ… Novo pagamento registrado   â”‚
â”‚    (nÃ£o cria matrÃ­culas novamente)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
    (30 dias depois)
         â†“
MÃŠS 3: CobranÃ§a AutomÃ¡tica
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MP cobra cartÃ£o automaticamente â”‚
â”‚        â†“                        â”‚
â”‚ payment_id = 888888            â”‚
â”‚        â†“                        â”‚
â”‚ Webhook: payment #3            â”‚
â”‚ âœ… Novo pagamento registrado   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
    [Continua indefinidamente...]
         â†“
QUANDO CANCELAR?
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Cliente cancela assinatura     â”‚
â”‚        â†“                        â”‚
â”‚ Webhook: subscription_cancelledâ”‚
â”‚        â†“                        â”‚
â”‚ MatrÃ­cula marcada "cancelada"  â”‚
â”‚ PrÃ³ximas cobranÃ§as: paradas    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 6ï¸âƒ£ **COMPARAÃ‡ÃƒO: ANTES vs DEPOIS**

```
âŒ ANTES (Quebrado)                    âœ… DEPOIS (Funcionando)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Webhook chega                          Webhook assinatura chega
   â†“                                      â†“
Metadata vazio                         criarMatriculaPagantePacote()
   â†“                                      â†“
âŒ NÃ£o consegue processar            âœ… MatrÃ­cula pagante criada
âŒ Nenhuma matrÃ­cula criada          âœ… Assinatura criada
âŒ "sucesso" falso                   âœ… pacote_contrato_id armazenado
                                          â†“
                                      Webhook pagamento chega
                                          â†“
                                      processarPagamentoPacote()
                                          â†“
                                      Busca assinatura anterior
                                          â†“
                                      âœ… Recupera pacote mesmo sem metadata!
                                      âœ… Cria matrÃ­culas beneficiÃ¡rios
                                      âœ… Marca como pago
                                      âœ… Contrato ativo
```

---

## ğŸ¯ **SumÃ¡rio em 5 Linhas**

1. **POST** â†’ `/mobile/pacotes/contratos/4/pagar`
2. **Backend** â†’ Cria preferÃªncia/preapproval no MP
3. **Frontend** â†’ Redireciona cliente para checkout MP
4. **Cliente** â†’ Paga no MP
5. **Webhooks** â†’ #1 (assinatura) + #2 (pagamento) processam tudo automaticamente

**Resultado:** 4 matrÃ­culas ativas + assinatura recorrente em ~2-3 segundos

