<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/admin"></ion-back-button>
    </ion-buttons>
    <ion-title>Planejamento de Horários</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="abrirModal()">
        <ion-icon slot="icon-only" name="add"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <div class="planejamentos-container">
    <div class="header-info">
      <h2>Planejamentos Semanais</h2>
      <p>Crie horários recorrentes para cada dia da semana</p>
    </div>

    <ion-spinner *ngIf="loading" name="crescent"></ion-spinner>

    <ion-grid *ngIf="!loading">
      <ion-row>
        <ion-col size="12" size-md="6" *ngFor="let planejamento of planejamentos">
          <ion-card>
            <ion-card-header>
              <div class="card-header-content">
                <div>
                  <ion-card-title>{{ planejamento.titulo }}</ion-card-title>
                  <ion-badge [color]="planejamento.ativo ? 'success' : 'medium'">
                    {{ planejamento.ativo ? 'Ativo' : 'Inativo' }}
                  </ion-badge>
                </div>
                <div class="card-actions">
                  <ion-button fill="clear" size="small" (click)="abrirModal(planejamento)">
                    <ion-icon slot="icon-only" name="create"></ion-icon>
                  </ion-button>
                  <ion-button fill="clear" size="small" color="danger" (click)="desativar(planejamento)">
                    <ion-icon slot="icon-only" name="trash"></ion-icon>
                  </ion-button>
                </div>
              </div>
            </ion-card-header>
            
            <ion-card-content>
              <div class="planejamento-info">
                <div class="info-item">
                  <ion-icon name="calendar"></ion-icon>
                  <span>{{ getNomeDiaSemana(planejamento.dia_semana) }}</span>
                </div>
                
                <div class="info-item">
                  <ion-icon name="time"></ion-icon>
                  <span>{{ planejamento.horario_inicio }} - {{ planejamento.horario_fim }}</span>
                </div>
                
                <div class="info-item">
                  <ion-icon name="people"></ion-icon>
                  <span>{{ planejamento.vagas }} vagas</span>
                </div>
                
                <div class="info-item period">
                  <strong>Período:</strong>
                  <span>{{ formatarData(planejamento.data_inicio) }} até {{ formatarData(planejamento.data_fim) }}</span>
                </div>
              </div>

              <ion-button 
                expand="block" 
                fill="outline" 
                size="small"
                (click)="abrirModalGerar(planejamento)"
                class="ion-margin-top"
              >
                <ion-icon slot="start" name="checkmark"></ion-icon>
                Gerar Horários
              </ion-button>
            </ion-card-content>
          </ion-card>
        </ion-col>
      </ion-row>
    </ion-grid>

    <!-- Mensagem quando vazio -->
    <div *ngIf="!loading && planejamentos.length === 0" class="empty-state">
      <ion-icon name="calendar"></ion-icon>
      <h3>Nenhum planejamento cadastrado</h3>
      <p>Crie seu primeiro planejamento de horários semanais</p>
      <ion-button (click)="abrirModal()">
        <ion-icon slot="start" name="add"></ion-icon>
        Criar Planejamento
      </ion-button>
    </div>
  </div>

  <!-- Modal Criar/Editar Planejamento -->
  <ion-modal [isOpen]="modalAberto" (didDismiss)="fecharModal()">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>{{ modoEdicao ? 'Editar' : 'Novo' }} Planejamento</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="fecharModal()">
              <ion-icon name="close"></ion-icon>
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      
      <ion-content class="ion-padding">
        <form [formGroup]="planejamentoForm">
          <ion-item>
            <ion-label position="floating">Título *</ion-label>
            <ion-input formControlName="titulo" placeholder="Ex: Horários Janeiro 2024"></ion-input>
          </ion-item>

          <ion-item>
            <ion-label position="floating">Dia da Semana *</ion-label>
            <ion-select formControlName="dia_semana" placeholder="Selecione">
              <ion-select-option *ngFor="let dia of diasSemana" [value]="dia.value">
                {{ dia.label }}
              </ion-select-option>
            </ion-select>
          </ion-item>

          <ion-item>
            <ion-label position="floating">Horário Início *</ion-label>
            <ion-input formControlName="horario_inicio" type="time"></ion-input>
          </ion-item>

          <ion-item>
            <ion-label position="floating">Horário Fim *</ion-label>
            <ion-input formControlName="horario_fim" type="time"></ion-input>
          </ion-item>

          <ion-item>
            <ion-label position="floating">Vagas *</ion-label>
            <ion-input formControlName="vagas" type="number" min="1"></ion-input>
          </ion-item>

          <ion-item>
            <ion-label position="floating">Data Início *</ion-label>
            <ion-input formControlName="data_inicio" type="date"></ion-input>
          </ion-item>

          <ion-item>
            <ion-label position="floating">Data Fim (opcional)</ion-label>
            <ion-input formControlName="data_fim" type="date"></ion-input>
          </ion-item>

          <ion-item>
            <ion-label>Ativo</ion-label>
            <ion-toggle formControlName="ativo" slot="end"></ion-toggle>
          </ion-item>

          <ion-button 
            expand="block" 
            (click)="salvarPlanejamento()"
            [disabled]="planejamentoForm.invalid"
            class="ion-margin-top"
          >
            <ion-icon slot="start" name="checkmark"></ion-icon>
            {{ modoEdicao ? 'Atualizar' : 'Criar' }}
          </ion-button>
        </form>
      </ion-content>
    </ng-template>
  </ion-modal>

  <!-- Modal Gerar Horários -->
  <ion-modal [isOpen]="modalGerarAberto" (didDismiss)="fecharModalGerar()">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>Gerar Horários</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="fecharModalGerar()">
              <ion-icon name="close"></ion-icon>
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      
      <ion-content class="ion-padding">
        <div *ngIf="planejamentoSelecionado" class="gerar-info">
          <h3>{{ planejamentoSelecionado.titulo }}</h3>
          <p>{{ getNomeDiaSemana(planejamentoSelecionado.dia_semana) }} - {{ planejamentoSelecionado.horario_inicio }}</p>
          <p class="description">
            Os horários serão criados automaticamente para todas as {{ getNomeDiaSemana(planejamentoSelecionado.dia_semana) }}s
            no período selecionado.
          </p>
        </div>

        <form [formGroup]="gerarHorariosForm">
          <ion-item>
            <ion-label position="floating">Data Início *</ion-label>
            <ion-input formControlName="data_inicio" type="date"></ion-input>
          </ion-item>

          <ion-item>
            <ion-label position="floating">Data Fim *</ion-label>
            <ion-input formControlName="data_fim" type="date"></ion-input>
          </ion-item>

          <ion-button 
            expand="block" 
            (click)="gerarHorarios()"
            [disabled]="gerarHorariosForm.invalid"
            class="ion-margin-top"
          >
            <ion-icon slot="start" name="checkmark"></ion-icon>
            Gerar Horários
          </ion-button>
        </form>
      </ion-content>
    </ng-template>
  </ion-modal>
</ion-content>
