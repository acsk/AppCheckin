# Habilitar reescrita de URL (compatível com dist na raiz OU dist em /dist)
<IfModule mod_rewrite.c>
  RewriteEngine On
  RewriteBase /

  # Forçar o index da pasta dist mesmo que exista index.html na raiz
  RewriteCond %{DOCUMENT_ROOT}/dist/index.html -f
  RewriteRule ^index\.html$ /dist/index.html [L,NC]

  RewriteCond %{DOCUMENT_ROOT}/dist/index.html -f
  RewriteRule ^$ /dist/index.html [L,NC]

  # Se os assets estiverem em /dist (deploy com pasta dist), mapear /_expo e /assets
  # (mesmo que exista /assets na raiz, priorizar /dist/assets)
  RewriteCond %{DOCUMENT_ROOT}/dist/_expo -d
  RewriteRule ^_expo/(.*)$ /dist/_expo/$1 [L,NC]

  RewriteCond %{DOCUMENT_ROOT}/dist/assets -d
  RewriteRule ^assets/(.*)$ /dist/assets/$1 [L,NC]

  RewriteCond %{DOCUMENT_ROOT}/dist/favicon.ico -f
  RewriteRule ^favicon.ico$ /dist/favicon.ico [L,NC]

  # Deixar arquivos reais no servidor passarem (não reescrever)
  RewriteCond %{REQUEST_FILENAME} -f [OR]
  RewriteCond %{REQUEST_FILENAME} -d
  RewriteRule ^ - [L]

  # SPA fallback quando dist está na raiz (assets em /_expo)
  RewriteCond %{DOCUMENT_ROOT}/index.html -f
  RewriteCond %{DOCUMENT_ROOT}/_expo -d
  RewriteRule ^$ /index.html [L,NC]
  RewriteCond %{DOCUMENT_ROOT}/index.html -f
  RewriteCond %{DOCUMENT_ROOT}/_expo -d
  RewriteRule ^.*$ /index.html [L]

  # SPA fallback quando dist fica dentro de /dist
  RewriteCond %{DOCUMENT_ROOT}/dist/index.html -f
  RewriteRule ^$ /dist/index.html [L,NC]
  RewriteCond %{DOCUMENT_ROOT}/dist/index.html -f
  RewriteRule ^.*$ /dist/index.html [L]
</IfModule>

# Tipos MIME
<IfModule mod_mime.c>
  AddType application/javascript js
  AddType application/json json
  AddType text/css css
</IfModule>

# Cache
<IfModule mod_headers.c>
  <FilesMatch "\.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2)$">
    Header set Cache-Control "max-age=31536000, public"
  </FilesMatch>
  <FilesMatch "\.html$">
    Header set Cache-Control "no-cache, no-store, must-revalidate"
  </FilesMatch>
</IfModule>

# Compressão
<IfModule mod_deflate.c>
  AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json
</IfModule>

# Configurar tipos MIME
<IfModule mod_mime.c>
  AddType application/javascript js
  AddType application/json json
  AddType text/css css
  AddEncoding gzip .gz
</IfModule>

# Cache
<IfModule mod_headers.c>
  # Cache para arquivos estáticos
  <FilesMatch "\.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2)$">
    Header set Cache-Control "max-age=31536000, public"
  </FilesMatch>
  
  # Sem cache para HTML
  <FilesMatch "\.html$">
    Header set Cache-Control "no-cache, no-store, must-revalidate"
  </FilesMatch>
</IfModule>

# Compressão GZIP
<IfModule mod_deflate.c>
  AddOutputFilterByType DEFLATE text/html
  AddOutputFilterByType DEFLATE text/plain
  AddOutputFilterByType DEFLATE text/xml
  AddOutputFilterByType DEFLATE text/css
  AddOutputFilterByType DEFLATE text/javascript
  AddOutputFilterByType DEFLATE application/xml
  AddOutputFilterByType DEFLATE application/xhtml+xml
  AddOutputFilterByType DEFLATE application/rss+xml
  AddOutputFilterByType DEFLATE application/javascript
  AddOutputFilterByType DEFLATE application/x-javascript
  AddOutputFilterByType DEFLATE application/json
</IfModule>
